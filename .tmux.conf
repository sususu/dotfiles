# Settings
# --------------------------------------------------------------------------------------------------

# set-window-option -g aggressive-resize off
set-window-option -g aggressive-resize on

# Enable UTF8
set-window-option -g utf8 on

# 親端末のTERMがxtermの場合
set-option -g terminal-overrides 'xterm*:smcup@:rmcup@'

set-option -g default-terminal 'screen-256color'
set-option -g terminal-overrides 'xterm:colors=256'

set-option -sg escape-time 0

# Mouse
# --------------------------------------------------------------------------------------------------

# > There do not appear to be any default bindings for the mouse wheel in 2.1. You'll need to add them.
# One of the changes in 2.1 is to make mouse events bindable instead of having the behavior built in.
# cf. [tmux 2.1 has been released : tmux](https://www.reddit.com/r/tmux/comments/3paqoi/tmux_21_has_been_released/)
if-shell "~/dotfiles/bin/tmux-check-version 2.0" '\
  set-option -g mouse-utf8 on; \
  set-option -g mouse on; \
'

unbind -T root WheelUpPane
unbind -T root WheelDownPane
bind -T root WheelUpPane if -Ft= '#{mouse_any_flag}' 'send-keys -M' 'if -Ft= "#{pane_in_mode}" "send-keys -M" "copy-mode -eu"'
bind-key -t vi-copy WheelUpPane halfpage-up
bind-key -t vi-copy WheelDownPane halfpage-down

# ウィンドウ分割後もカレントディレクトリに留まる
if-shell "~/dotfiles/bin/tmux-check-version 1.9" '\
  bind n new-window -c "#{pane_current_path}"; \
  bind h split-window -h -c "#{pane_current_path}"; \
  bind v split-window -v -c "#{pane_current_path}"; \
'

# Status
# --------------------------------------------------------------------------------------------------

set-option -g status-utf8 on
set-window-option -g allow-rename off
set-window-option -g monitor-activity on
set-option -g visual-activity on
set-window-option -g window-status-current-format "#[fg=colour255,bg=colour241,bold] #I: #W #[default]"

if-shell "~/dotfiles/bin/tmux-check-version 1.7" '\
  set-option -g status-position top; \
'

# Start window numbers at 1
set-option -g base-index 1
set-window-option -g pane-base-index 1

# Renumber windows sequentially after closing any of them
if-shell "~/dotfiles/bin/tmux-check-version 1.7" '\
  set-option -g renumber-windows on; \
'

# Status
set-option -g status-justify left
set-option -g status-attr default

# Left panel
set-option -g status-left-length 50
set-option -g status-left \
"#{?client_prefix,#[reverse],}#[fg=green][#S:#I.#P]#[fg=yellow][#(whoami)@#h]  "

# Right panel
set-option -g status-right-length 80
set-option -g status-right \
"#{?client_prefix,#[reverse],}"\
"#[fg=green]#(${HOME}/dotfiles/bin/git-echo-tmux-current-branch)"\
"#[fg=yellow]#(${HOME}/dotfiles/bin/git-echo-tmux-username-and-email)"

# Color
# --------------------------------------------------------------------------------------------------

# window
set-option -g window-style 'fg=colour247,bg=colour236'
set-option -g window-active-style 'fg=colour250,bg=black'

# default statusbar colors
set-option -g status-bg black #base02
set-option -g status-fg yellow #yellow
set-option -g status-attr default

# default window title colors
set-window-option -g window-status-fg brightblue #base0
set-window-option -g window-status-bg default
# set-window-option -g window-status-attr dim

# active window title colors
set-window-option -g window-status-current-fg brightred #orange
set-window-option -g window-status-current-bg default
# set-window-option -g window-status-current-attr bright

# pane border
set-option -g pane-border-fg black #base02
set-option -g pane-active-border-fg brightgreen #base01

# message text
set-option -g message-bg black #base02
set-option -g message-fg brightred #orange

# pane number display
set-option -g display-panes-active-colour blue #blue
set-option -g display-panes-colour brightred #orange

# clock
set-window-option -g clock-mode-colour green #green

# Keybindings
# --------------------------------------------------------------------------------------------------

# Change prefix
unbind C-b
set-option -g prefix C-Space
# set-option -g prefix2 C-s
# bind-key Space send-prefix

# Reload config
bind-key r source-file ~/.tmux.conf \; display ".tmux.conf Reloaded"

# Change layout (override defaults)
bind-key C-1 source-file ~/dotfiles/tmux/tmux.window.1 \; display "Layout 1"
bind-key C-2 source-file ~/dotfiles/tmux/tmux.window.2 \; display "Layout 2"
bind-key C-3 source-file ~/dotfiles/tmux/tmux.window.3 \; display "Layout 3"
bind-key C-4 source-file ~/dotfiles/tmux/tmux.window.4 \; display "Layout 4"
bind-key C-5 source-file ~/dotfiles/tmux/tmux.window.5 \; display "Layout 5"

# Use vim-like keybindings
set-window-option -g mode-keys vi

# Copy mode
# --------------------------------------------------------------------------------------------------

unbind-key -t vi-copy Space
bind-key -t vi-copy v begin-selection

# Esc キーでコピーの反転を解除（コピーモードは抜けない）
bind-key -t vi-copy Escape clear-selection

# For Linux
if-shell "which xsel" '\
  unbind-key -t vi-copy Enter; \
  bind-key -t vi-copy y copy-pipe "xsel -ib"; \
  bind-key -t vi-copy Enter copy-pipe "xsel -ib"; \
'

# For Mac
if-shell "reattach-to-user-namespace" '\
  bind-key -t vi-copy y copy-pipe "reattach-to-user-namespace pbcopy"; \
'

# set-option -g default-command "reattach-to-user-namespace -l $SHELL"
# bind-key c copy-mode
# bind-key p paste-buffer

# Move pane/window
bind-key Space last-window
bind-key C-Space last-window
bind-key -r C-p select-window -t :-
bind-key -r C-n select-window -t :+
bind-key -n A-M-Left select-window -t :-
bind-key -n A-M-Right select-window -t :+
# bind-key -r C-i previous-window
# bind-key -r C-o next-window

# Smart pane switching with awareness of vim splits
# cf. [christoomey/vim-tmux-navigator](https://github.com/christoomey/vim-tmux-navigator)
is_vim='echo "#{pane_current_command}" | grep -iqE "(^|\/)g?(view|n?vim?)(diff)?$"'
bind -r C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"
bind -n C-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"

# Resize pane
bind-key -r h resize-pane -L
bind-key -r j resize-pane -D
bind-key -r k resize-pane -U
bind-key -r l resize-pane -R

# Select window
bind-key b choose-window

# Create new window
bind-key n new-window

# Split window
bind-key s split-window -v -c '#{pane_current_path}'
bind-key v split-window -h -c '#{pane_current_path}'
bind-key C-s split-window -v -c '#{pane_current_path}'
bind-key C-v split-window -h -c '#{pane_current_path}'

# Other

bind-key q kill-pane
bind-key Q kill-window
bind-key C-q kill-pane
bind-key C-Q kill-window

bind-key A set-window-option synchronize-panes on
bind-key a set-window-option synchronize-panes off
bind-key C-A set-window-option synchronize-panes on
bind-key a set-window-option synchronize-panes off

bind-key i send-keys -R \; clear-history
bind-key C-i send-keys -R \; clear-history
bind-key o send-keys -R \; clear-history
bind-key C-o send-keys -R \; clear-history

# Plugins
# --------------------------------------------------------------------------------------------------

# Install tmux plugins using Tmux Plugin Manager
# tmux-plugins/tmux-yank
set-option -g @tpm_plugins ' \
  tmux-plugins/tpm \
  tmux-plugins/tmux-copycat \
  tmux-plugins/tmux-open \
  tmux-plugins/tmux-resurrect \
'
set-option -g @resurrect-strategy-vim 'session'
set-option -g @resurrect-strategy-nvim 'session'
# set-option -g @resurrect-save 'S'
# set-option -g @resurrect-restore 'R'
run-shell '~/.tmux/plugins/tpm/tpm'

# Editor
# --------------------------------------------------------------------------------------------------

# For shell vi mode compatibility
set-option -g @shell_mode 'vi'

# Workaround
# --------------------------------------------------------------------------------------------------

# Workaround for atom and Electron
# cf. [tmux下でElectronがうまく動作しない - Qiita](http://qiita.com/itkrt2y/items/dee87c406617d1bd45a6)
# cf. [tmux から atom コマンドでファイルを開こうとするとエラーが出る問題 - Kaihatsu](http://dev.jgs.me/2015/01/06/atom-LSOpenURLsWithRole-error.html)
set-option -g default-command "which reattach-to-user-namespace > /dev/null && reattach-to-user-namespace -l $SHELL || $SHELL"

# Workaround for the system freeze issue on OS X El Capitan
# cf. [Tmux freezes Mac when killing a long running session · Issue #108 · tmux/tmux](https://github.com/tmux/tmux/issues/108)
# TODO: Remove this when fixed
# set-option -g status off
# set-option -g status-interval 0

# cf. [tmuxでマウスを使う](http://mojavy.com/blog/2011/12/13/tmux_advent_calendar_2_2011/)
# cf. [達人に学ぶ.tmux.confの基本設定 - Qiita](http://qiita.com/succi0303/items/cb396704493476373edf)
# cf. [Vim - ターミナルマルチプレクサ tmux をカスタマイズする - Qiita](http://qiita.com/b4b4r07/items/01359e8a3066d1c37edc)
# cf. [2015年の\(ほどほどにつよい\) tmux環境設定まとめ \- Qiita](http://qiita.com/koara-local/items/940ce66e2ecd8e4d8582)
