# ref:
#   [tmuxでマウスを使う](http://mojavy.com/blog/2011/12/13/tmux_advent_calendar_2_2011/)
#   [達人に学ぶ.tmux.confの基本設定 - Qiita](http://qiita.com/succi0303/items/cb396704493476373edf)
#   [Vim - ターミナルマルチプレクサ tmux をカスタマイズする - Qiita](http://qiita.com/b4b4r07/items/01359e8a3066d1c37edc)

# Enable UTF8
set-window-option -g utf8 on

# Status
set-option -g status-utf8 on
set-window-option -g monitor-activity on
set-option -g visual-activity on
set-option -g status-position top

# Mouse
# > There do not appear to be any default bindings for the mouse wheel in 2.1. You'll need to add them.
# One of the changes in 2.1 is to make mouse events bindable instead of having the behavior built in.
# cf. [tmux 2.1 has been released : tmux](https://www.reddit.com/r/tmux/comments/3paqoi/tmux_21_has_been_released/)
set-option -g mouse-utf8 on
set-option -g mouse on

unbind -T root WheelUpPane
unbind -T root WheelDownPane
bind -T root WheelUpPane if -Ft= '#{mouse_any_flag}' 'send-keys -M' 'if -Ft= "#{pane_in_mode}" "send-keys -M" "copy-mode -eu"'
bind-key -t vi-copy WheelUpPane halfpage-up
bind-key -t vi-copy WheelDownPane halfpage-down

# Window resize
set-window-option -g aggressive-resize on

# Workaround for the system freeze issue on OS X El Capitan
# cf. [Tmux freezes Mac when killing a long running session · Issue #108 · tmux/tmux](https://github.com/tmux/tmux/issues/108)
# set-option -g status off
set-option -g status-interval 0

# 親端末のTERMがxtermの場合
set-option -g terminal-overrides 'xterm*:smcup@:rmcup@'

set-option -g default-terminal 'screen-256color'
set-option -g terminal-overrides 'xterm:colors=256'

set-option -sg escape-time 0

# Start window numbers at 1
set-option -g base-index 1
set-window-option -g pane-base-index 1

# Renumber windows sequentially after closing any of them
set-option -g renumber-windows on

# Color
# set-option -g status-left ''
# set-option -g status-right ''
set-option -g status-bg 'green'
set-option -g status-fg '#333333'
set-option -g pane-border-fg 'black'
set-option -g pane-active-border-fg 'green'

# Keybindings

# Change prefix
# set-option -g prefix2 C-s

# Reload config
bind-key r source-file ~/.tmux.conf \; display ".tmux.conf Reloaded"

# Change layout (override defaults)
bind-key C-1 source-file ~/dotfiles/tmux/tmux.window.1 \; display "Layout 1"
bind-key C-2 source-file ~/dotfiles/tmux/tmux.window.2 \; display "Layout 2"
bind-key C-3 source-file ~/dotfiles/tmux/tmux.window.3 \; display "Layout 3"
bind-key C-4 source-file ~/dotfiles/tmux/tmux.window.4 \; display "Layout 4"
bind-key C-5 source-file ~/dotfiles/tmux/tmux.window.5 \; display "Layout 5"

# Use vim-like keybindings
set-window-option -g mode-keys vi

# Copy mode

# # Note: In Mac, you need install reattach-to-user-namespace
# #   $ brew install reattach-to-user-namespace
# set-option -g default-command "reattach-to-user-namespace -l $SHELL"
bind-key c copy-mode
# bind-key -t vi-copy v begin-selection
# bind-key -t vi-copy y copy-pipe "reattach-to-user-namespace pbcopy"
# unbind-key -t vi-copy Enter
# unbind-key -t vi-copy Space
bind-key p paste-buffer

# Esc キーでコピーの反転を解除（コピーモードは抜けない）
bind-key -t vi-copy Escape clear-selection

# Display panes
# bind-key i display-panes

# Move pane/window
bind-key b last-pane
bind-key C-b last-pane
bind-key -r C-p select-window -t :-
bind-key -r C-n select-window -t :+
# bind-key -r C-i previous-window
# bind-key -r C-o next-window

# Smart pane switching with awareness of vim splits
# cf. [christoomey/vim-tmux-navigator](https://github.com/christoomey/vim-tmux-navigator)
is_vim='echo "#{pane_current_command}" | grep -iqE "(^|\/)g?(view|n?vim?)(diff)?$"'
bind -r C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"
bind -n C-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"

# Resize pane
bind-key -r h resize-pane -L
bind-key -r j resize-pane -D
bind-key -r k resize-pane -U
bind-key -r l resize-pane -R

# Select window
bind-key b choose-window

# Create new window
bind-key n new-window

# Split window
bind-key s split-window -v -c '#{pane_current_path}'
bind-key v split-window -h -c '#{pane_current_path}'
bind-key C-s split-window -v -c '#{pane_current_path}'
bind-key C-v split-window -h -c '#{pane_current_path}'

# Other
bind-key q kill-pane
bind-key Q kill-window
bind-key C-q kill-pane
bind-key C-Q kill-window

bind-key A set-window-option synchronize-panes on
bind-key a set-window-option synchronize-panes off
bind-key C-A set-window-option synchronize-panes on
bind-key a set-window-option synchronize-panes off

# Install tmux plugins using Tmux Plugin Manager
# tmux-plugins/tmux-yank
set-option -g @tpm_plugins ' \
  tmux-plugins/tpm \
  tmux-plugins/tmux-copycat \
  tmux-plugins/tmux-open \
  tmux-plugins/tmux-resurrect \
'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'
# set-option -g @resurrect-save 'S'
# set-option -g @resurrect-restore 'R'
run-shell '~/.tmux/plugins/tpm/tpm'

# For shell vi mode compatibility
set -g @shell_mode 'vi'
